var oe=async(s,e=Object.create(null))=>{let{all:t=!1,dot:n=!1}=e,a=(s instanceof S?s.raw.headers:s.headers).get("Content-Type");return a?.startsWith("multipart/form-data")||a?.startsWith("application/x-www-form-urlencoded")?Oe(s,{all:t,dot:n}):{}};async function Oe(s,e){let t=await s.formData();return t?ve(t,e):{}}function ve(s,e){let t=Object.create(null);return s.forEach((n,r)=>{e.all||r.endsWith("[]")?He(t,r,n):t[r]=n}),e.dot&&Object.entries(t).forEach(([n,r])=>{n.includes(".")&&(we(t,n,r),delete t[n])}),t}var He=(s,e,t)=>{s[e]!==void 0?Array.isArray(s[e])?s[e].push(t):s[e]=[s[e],t]:s[e]=t},we=(s,e,t)=>{let n=s,r=e.split(".");r.forEach((a,o)=>{o===r.length-1?n[a]=t:((!n[a]||typeof n[a]!="object"||Array.isArray(n[a])||n[a]instanceof File)&&(n[a]=Object.create(null)),n=n[a])})};var z=s=>{let e=s.split("/");return e[0]===""&&e.shift(),e},ie=s=>{let{groups:e,path:t}=Ce(s),n=z(t);return Me(n,e)},Ce=s=>{let e=[];return s=s.replace(/\{[^}]+\}/g,(t,n)=>{let r=`@${n}`;return e.push([r,t]),r}),{groups:e,path:s}},Me=(s,e)=>{for(let t=e.length-1;t>=0;t--){let[n]=e[t];for(let r=s.length-1;r>=0;r--)if(s[r].includes(n)){s[r]=s[r].replace(n,e[t][1]);break}}return s},L={},Q=s=>{if(s==="*")return"*";let e=s.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);return e?(L[s]||(e[2]?L[s]=[s,e[1],new RegExp("^"+e[2]+"$")]:L[s]=[s,e[1],!0]),L[s]):null},Y=(s,e)=>{try{return e(s)}catch{return s.replace(/(?:%[0-9A-Fa-f]{2})+/g,t=>{try{return e(t)}catch{return t}})}},ke=s=>Y(s,decodeURI),X=s=>{let e=s.url,t=e.indexOf("/",8),n=t;for(;n<e.length;n++){let r=e.charCodeAt(n);if(r===37){let a=e.indexOf("?",n),o=e.slice(t,a===-1?void 0:a);return ke(o.includes("%25")?o.replace(/%25/g,"%2525"):o)}else if(r===63)break}return e.slice(t,n)};var ce=s=>{let e=X(s);return e.length>1&&e.at(-1)==="/"?e.slice(0,-1):e},b=(...s)=>{let e="",t=!1;for(let n of s)e.at(-1)==="/"&&(e=e.slice(0,-1),t=!0),n[0]!=="/"&&(n=`/${n}`),n==="/"&&t?e=`${e}/`:n!=="/"&&(e=`${e}${n}`),n==="/"&&e===""&&(e="/");return e},N=s=>{if(!s.match(/\:.+\?$/))return null;let e=s.split("/"),t=[],n="";return e.forEach(r=>{if(r!==""&&!/\:/.test(r))n+="/"+r;else if(/\:/.test(r))if(/\?/.test(r)){t.length===0&&n===""?t.push("/"):t.push(n);let a=r.replace("?","");n+="/"+a,t.push(n)}else n+="/"+r}),t.filter((r,a,o)=>o.indexOf(r)===a)},G=s=>/[%+]/.test(s)?(s.indexOf("+")!==-1&&(s=s.replace(/\+/g," ")),s.indexOf("%")!==-1?Z(s):s):s,de=(s,e,t)=>{let n;if(!t&&e&&!/[%+]/.test(e)){let o=s.indexOf(`?${e}`,8);for(o===-1&&(o=s.indexOf(`&${e}`,8));o!==-1;){let d=s.charCodeAt(o+e.length+1);if(d===61){let c=o+e.length+2,i=s.indexOf("&",c);return G(s.slice(c,i===-1?void 0:i))}else if(d==38||isNaN(d))return"";o=s.indexOf(`&${e}`,o+1)}if(n=/[%+]/.test(s),!n)return}let r={};n??=/[%+]/.test(s);let a=s.indexOf("?",8);for(;a!==-1;){let o=s.indexOf("&",a+1),d=s.indexOf("=",a);d>o&&o!==-1&&(d=-1);let c=s.slice(a+1,d===-1?o===-1?void 0:o:d);if(n&&(c=G(c)),a=o,c==="")continue;let i;d===-1?i="":(i=s.slice(d+1,o===-1?void 0:o),n&&(i=G(i))),t?(r[c]&&Array.isArray(r[c])||(r[c]=[]),r[c].push(i)):r[c]??=i}return e?r[e]:r},le=de,ue=(s,e)=>de(s,e,!0),Z=decodeURIComponent;var pe=s=>Y(s,Z),S=class{raw;#t;#e;routeIndex=0;path;bodyCache={};constructor(e,t="/",n=[[]]){this.raw=e,this.path=t,this.#e=n,this.#t={}}param(e){return e?this.#r(e):this.#a()}#r(e){let t=this.#e[0][this.routeIndex][1][e],n=this.#s(t);return n?/\%/.test(n)?pe(n):n:void 0}#a(){let e={},t=Object.keys(this.#e[0][this.routeIndex][1]);for(let n of t){let r=this.#s(this.#e[0][this.routeIndex][1][n]);r&&typeof r=="string"&&(e[n]=/\%/.test(r)?pe(r):r)}return e}#s(e){return this.#e[1]?this.#e[1][e]:e}query(e){return le(this.url,e)}queries(e){return ue(this.url,e)}header(e){if(e)return this.raw.headers.get(e.toLowerCase())??void 0;let t={};return this.raw.headers.forEach((n,r)=>{t[r]=n}),t}async parseBody(e){return this.bodyCache.parsedBody??=await oe(this,e)}#n=e=>{let{bodyCache:t,raw:n}=this,r=t[e];if(r)return r;let a=Object.keys(t)[0];return a?t[a].then(o=>(a==="json"&&(o=JSON.stringify(o)),new Response(o)[e]())):t[e]=n[e]()};json(){return this.#n("json")}text(){return this.#n("text")}arrayBuffer(){return this.#n("arrayBuffer")}blob(){return this.#n("blob")}formData(){return this.#n("formData")}addValidatedData(e,t){this.#t[e]=t}valid(e){return this.#t[e]}get url(){return this.raw.url}get method(){return this.raw.method}get matchedRoutes(){return this.#e[0].map(([[,e]])=>e)}get routePath(){return this.#e[0].map(([[,e]])=>e)[this.routeIndex].path}};var fe={Stringify:1,BeforeStream:2,Stream:3},Be=(s,e)=>{let t=new String(s);return t.isEscaped=!0,t.callbacks=e,t};var ee=async(s,e,t,n,r)=>{typeof s=="object"&&!(s instanceof String)&&(s instanceof Promise||(s=s.toString()),s instanceof Promise&&(s=await s));let a=s.callbacks;if(!a?.length)return Promise.resolve(s);r?r[0]+=s:r=[s];let o=Promise.all(a.map(d=>d({phase:e,buffer:r,context:n}))).then(d=>Promise.all(d.filter(Boolean).map(c=>ee(c,e,!1,n,r))).then(()=>r[0]));return t?Be(await o,a):o};var Ie="text/plain; charset=UTF-8",te=(s,e={})=>{for(let t of Object.keys(e))s.set(t,e[t]);return s},T=class{#t;#e;env={};#r;finalized=!1;error;#a=200;#s;#n;#o;#c;#d=!0;#p;#l;#u;#f;#h;constructor(e,t){this.#t=e,t&&(this.#s=t.executionCtx,this.env=t.env,this.#u=t.notFoundHandler,this.#h=t.path,this.#f=t.matchResult)}get req(){return this.#e??=new S(this.#t,this.#h,this.#f),this.#e}get event(){if(this.#s&&"respondWith"in this.#s)return this.#s;throw Error("This context has no FetchEvent")}get executionCtx(){if(this.#s)return this.#s;throw Error("This context has no ExecutionContext")}get res(){return this.#d=!1,this.#c||=new Response("404 Not Found",{status:404})}set res(e){if(this.#d=!1,this.#c&&e)try{for(let[t,n]of this.#c.headers.entries())if(t!=="content-type")if(t==="set-cookie"){let r=this.#c.headers.getSetCookie();e.headers.delete("set-cookie");for(let a of r)e.headers.append("set-cookie",a)}else e.headers.set(t,n)}catch(t){if(t instanceof TypeError&&t.message.includes("immutable")){this.res=new Response(e.body,{headers:e.headers,status:e.status});return}else throw t}this.#c=e,this.finalized=!0}render=(...e)=>(this.#l??=t=>this.html(t),this.#l(...e));setLayout=e=>this.#p=e;getLayout=()=>this.#p;setRenderer=e=>{this.#l=e};header=(e,t,n)=>{if(t===void 0){this.#n?this.#n.delete(e):this.#o&&delete this.#o[e.toLocaleLowerCase()],this.finalized&&this.res.headers.delete(e);return}n?.append?(this.#n||(this.#d=!1,this.#n=new Headers(this.#o),this.#o={}),this.#n.append(e,t)):this.#n?this.#n.set(e,t):(this.#o??={},this.#o[e.toLowerCase()]=t),this.finalized&&(n?.append?this.res.headers.append(e,t):this.res.headers.set(e,t))};status=e=>{this.#d=!1,this.#a=e};set=(e,t)=>{this.#r??=new Map,this.#r.set(e,t)};get=e=>this.#r?this.#r.get(e):void 0;get var(){return this.#r?Object.fromEntries(this.#r):{}}#i(e,t,n){if(this.#d&&!n&&!t&&this.#a===200)return new Response(e,{headers:this.#o});if(t&&typeof t!="number"){let a=new Headers(t.headers);this.#n&&this.#n.forEach((d,c)=>{c==="set-cookie"?a.append(c,d):a.set(c,d)});let o=te(a,this.#o);return new Response(e,{headers:o,status:t.status??this.#a})}let r=typeof t=="number"?t:this.#a;this.#o??={},this.#n??=new Headers,te(this.#n,this.#o),this.#c&&(this.#c.headers.forEach((a,o)=>{o==="set-cookie"?this.#n?.append(o,a):this.#n?.set(o,a)}),te(this.#n,this.#o)),n??={};for(let[a,o]of Object.entries(n))if(typeof o=="string")this.#n.set(a,o);else{this.#n.delete(a);for(let d of o)this.#n.append(a,d)}return new Response(e,{status:r,headers:this.#n})}newResponse=(...e)=>this.#i(...e);body=(e,t,n)=>typeof t=="number"?this.#i(e,t,n):this.#i(e,t);text=(e,t,n)=>{if(!this.#o){if(this.#d&&!n&&!t)return new Response(e);this.#o={}}return this.#o["content-type"]=Ie,typeof t=="number"?this.#i(e,t,n):this.#i(e,t)};json=(e,t,n)=>{let r=JSON.stringify(e);return this.#o??={},this.#o["content-type"]="application/json",typeof t=="number"?this.#i(r,t,n):this.#i(r,t)};html=(e,t,n)=>(this.#o??={},this.#o["content-type"]="text/html; charset=UTF-8",typeof e=="object"?ee(e,fe.Stringify,!1,{}).then(r=>typeof t=="number"?this.#i(r,t,n):this.#i(r,t)):typeof t=="number"?this.#i(e,t,n):this.#i(e,t));redirect=(e,t)=>(this.#n??=new Headers,this.#n.set("Location",String(e)),this.newResponse(null,t??302));notFound=()=>(this.#u??=()=>new Response,this.#u(this))};var ne=(s,e,t)=>(n,r)=>{let a=-1,o=n instanceof T;return d(0);async function d(c){if(c<=a)throw new Error("next() called multiple times");a=c;let i,l=!1,u;if(s[c]?(u=s[c][0][0],o&&(n.req.routeIndex=c)):u=c===s.length&&r||void 0,!u)o&&n.finalized===!1&&t&&(i=await t(n));else try{i=await u(n,()=>d(c+1))}catch(p){if(p instanceof Error&&o&&e)n.error=p,i=await e(p,n),l=!0;else throw p}return i&&(n.finalized===!1||l)&&(n.res=i),n}};var h="ALL",he="all",ge=["get","post","put","delete","options","patch"],j="Can not add a route since the matcher is already built.",P=class extends Error{};var me="__COMPOSED_HANDLER";var Ae=s=>s.text("404 Not Found",404),ye=(s,e)=>"getResponse"in s?s.getResponse():(console.error(s),e.text("Internal Server Error",500)),q=class s{get;post;put;delete;options;patch;all;on;use;router;getPath;_basePath="/";#t="/";routes=[];constructor(e={}){[...ge,he].forEach(r=>{this[r]=(a,...o)=>(typeof a=="string"?this.#t=a:this.#a(r,this.#t,a),o.forEach(d=>{this.#a(r,this.#t,d)}),this)}),this.on=(r,a,...o)=>{for(let d of[a].flat()){this.#t=d;for(let c of[r].flat())o.map(i=>{this.#a(c.toUpperCase(),this.#t,i)})}return this},this.use=(r,...a)=>(typeof r=="string"?this.#t=r:(this.#t="*",a.unshift(r)),a.forEach(o=>{this.#a(h,this.#t,o)}),this);let n=e.strict??!0;delete e.strict,Object.assign(this,e),this.getPath=n?e.getPath??X:ce}#e(){let e=new s({router:this.router,getPath:this.getPath});return e.routes=this.routes,e}#r=Ae;errorHandler=ye;route(e,t){let n=this.basePath(e);return t.routes.map(r=>{let a;t.errorHandler===ye?a=r.handler:(a=async(o,d)=>(await ne([],t.errorHandler)(o,()=>r.handler(o,d))).res,a[me]=r.handler),n.#a(r.method,r.path,a)}),this}basePath(e){let t=this.#e();return t._basePath=b(this._basePath,e),t}onError=e=>(this.errorHandler=e,this);notFound=e=>(this.#r=e,this);mount(e,t,n){let r,a;n&&(typeof n=="function"?a=n:(a=n.optionHandler,r=n.replaceRequest));let o=a?c=>{let i=a(c);return Array.isArray(i)?i:[i]}:c=>{let i;try{i=c.executionCtx}catch{}return[c.env,i]};r||=(()=>{let c=b(this._basePath,e),i=c==="/"?0:c.length;return l=>{let u=new URL(l.url);return u.pathname=u.pathname.slice(i)||"/",new Request(u,l)}})();let d=async(c,i)=>{let l=await t(r(c.req.raw),...o(c));if(l)return l;await i()};return this.#a(h,b(e,"*"),d),this}#a(e,t,n){e=e.toUpperCase(),t=b(this._basePath,t);let r={path:t,method:e,handler:n};this.router.add(e,t,[n,r]),this.routes.push(r)}#s(e,t){if(e instanceof Error)return this.errorHandler(e,t);throw e}#n(e,t,n,r){if(r==="HEAD")return(async()=>new Response(null,await this.#n(e,t,n,"GET")))();let a=this.getPath(e,{env:n}),o=this.router.match(r,a),d=new T(e,{path:a,matchResult:o,env:n,executionCtx:t,notFoundHandler:this.#r});if(o[0].length===1){let i;try{i=o[0][0][0][0](d,async()=>{d.res=await this.#r(d)})}catch(l){return this.#s(l,d)}return i instanceof Promise?i.then(l=>l||(d.finalized?d.res:this.#r(d))).catch(l=>this.#s(l,d)):i??this.#r(d)}let c=ne(o[0],this.errorHandler,this.#r);return(async()=>{try{let i=await c(d);if(!i.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return i.res}catch(i){return this.#s(i,d)}})()}fetch=(e,...t)=>this.#n(e,t[1],t[0],e.method);request=(e,t,n,r)=>e instanceof Request?this.fetch(t?new Request(e,t):e,n,r):(e=e.toString(),this.fetch(new Request(/^https?:\/\//.test(e)?e:`http://localhost${b("/",e)}`,t),n,r));fire=()=>{addEventListener("fetch",e=>{e.respondWith(this.#n(e.request,e,void 0,e.request.method))})}};var V="[^/]+",w=".*",C="(?:|/.*)",D=Symbol(),Fe=new Set(".\\+*[^]$()");function Le(s,e){return s.length===1?e.length===1?s<e?-1:1:-1:e.length===1||s===w||s===C?1:e===w||e===C?-1:s===V?1:e===V?-1:s.length===e.length?s<e?-1:1:e.length-s.length}var U=class s{#t;#e;#r=Object.create(null);insert(e,t,n,r,a){if(e.length===0){if(this.#t!==void 0)throw D;if(a)return;this.#t=t;return}let[o,...d]=e,c=o==="*"?d.length===0?["","",w]:["","",V]:o==="/*"?["","",C]:o.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/),i;if(c){let l=c[1],u=c[2]||V;if(l&&c[2]&&(u=u.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(u)))throw D;if(i=this.#r[u],!i){if(Object.keys(this.#r).some(p=>p!==w&&p!==C))throw D;if(a)return;i=this.#r[u]=new s,l!==""&&(i.#e=r.varIndex++)}!a&&l!==""&&n.push([l,i.#e])}else if(i=this.#r[o],!i){if(Object.keys(this.#r).some(l=>l.length>1&&l!==w&&l!==C))throw D;if(a)return;i=this.#r[o]=new s}i.insert(d,t,n,r,a)}buildRegExpStr(){let t=Object.keys(this.#r).sort(Le).map(n=>{let r=this.#r[n];return(typeof r.#e=="number"?`(${n})@${r.#e}`:Fe.has(n)?`\\${n}`:n)+r.buildRegExpStr()});return typeof this.#t=="number"&&t.unshift(`#${this.#t}`),t.length===0?"":t.length===1?t[0]:"(?:"+t.join("|")+")"}};var _=class{#t={varIndex:0};#e=new U;insert(e,t,n){let r=[],a=[];for(let d=0;;){let c=!1;if(e=e.replace(/\{[^}]+\}/g,i=>{let l=`@\\${d}`;return a[d]=[l,i],d++,c=!0,l}),!c)break}let o=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let d=a.length-1;d>=0;d--){let[c]=a[d];for(let i=o.length-1;i>=0;i--)if(o[i].indexOf(c)!==-1){o[i]=o[i].replace(c,a[d][1]);break}}return this.#e.insert(o,t,r,this.#t,n),r}buildRegExp(){let e=this.#e.buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0,n=[],r=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(a,o,d)=>o!==void 0?(n[++t]=Number(o),"$()"):(d!==void 0&&(r[Number(d)]=++t),"")),[new RegExp(`^${e}`),n,r]}};var Re=[],Ne=[/^$/,[],Object.create(null)],xe=Object.create(null);function Ee(s){return xe[s]??=new RegExp(s==="*"?"":`^${s.replace(/\/\*$|([.\\+*[^\]$()])/g,(e,t)=>t?`\\${t}`:"(?:|/.*)")}$`)}function je(){xe=Object.create(null)}function qe(s){let e=new _,t=[];if(s.length===0)return Ne;let n=s.map(i=>[!/\*|\/:/.test(i[0]),...i]).sort(([i,l],[u,p])=>i?1:u?-1:l.length-p.length),r=Object.create(null);for(let i=0,l=-1,u=n.length;i<u;i++){let[p,g,f]=n[i];p?r[g]=[f.map(([y])=>[y,Object.create(null)]),Re]:l++;let m;try{m=e.insert(g,l,p)}catch(y){throw y===D?new P(g):y}p||(t[l]=f.map(([y,x])=>{let H=Object.create(null);for(x-=1;x>=0;x--){let[R,J]=m[x];H[R]=J}return[y,H]}))}let[a,o,d]=e.buildRegExp();for(let i=0,l=t.length;i<l;i++)for(let u=0,p=t[i].length;u<p;u++){let g=t[i][u]?.[1];if(!g)continue;let f=Object.keys(g);for(let m=0,y=f.length;m<y;m++)g[f[m]]=d[g[f[m]]]}let c=[];for(let i in o)c[i]=t[o[i]];return[a,c,r]}function O(s,e){if(s){for(let t of Object.keys(s).sort((n,r)=>r.length-n.length))if(Ee(t).test(e))return[...s[t]]}}var M=class{name="RegExpRouter";#t;#e;constructor(){this.#t={[h]:Object.create(null)},this.#e={[h]:Object.create(null)}}add(e,t,n){let r=this.#t,a=this.#e;if(!r||!a)throw new Error(j);r[e]||[r,a].forEach(c=>{c[e]=Object.create(null),Object.keys(c[h]).forEach(i=>{c[e][i]=[...c[h][i]]})}),t==="/*"&&(t="*");let o=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){let c=Ee(t);e===h?Object.keys(r).forEach(i=>{r[i][t]||=O(r[i],t)||O(r[h],t)||[]}):r[e][t]||=O(r[e],t)||O(r[h],t)||[],Object.keys(r).forEach(i=>{(e===h||e===i)&&Object.keys(r[i]).forEach(l=>{c.test(l)&&r[i][l].push([n,o])})}),Object.keys(a).forEach(i=>{(e===h||e===i)&&Object.keys(a[i]).forEach(l=>c.test(l)&&a[i][l].push([n,o]))});return}let d=N(t)||[t];for(let c=0,i=d.length;c<i;c++){let l=d[c];Object.keys(a).forEach(u=>{(e===h||e===u)&&(a[u][l]||=[...O(r[u],l)||O(r[h],l)||[]],a[u][l].push([n,o-i+c+1]))})}}match(e,t){je();let n=this.#r();return this.match=(r,a)=>{let o=n[r]||n[h],d=o[2][a];if(d)return d;let c=a.match(o[0]);if(!c)return[[],Re];let i=c.indexOf("",1);return[o[1][i],c]},this.match(e,t)}#r(){let e=Object.create(null);return Object.keys(this.#e).concat(Object.keys(this.#t)).forEach(t=>{e[t]||=this.#a(t)}),this.#t=this.#e=void 0,e}#a(e){let t=[],n=e===h;return[this.#t,this.#e].forEach(r=>{let a=r[e]?Object.keys(r[e]).map(o=>[o,r[e][o]]):[];a.length!==0?(n||=!0,t.push(...a)):e!==h&&t.push(...Object.keys(r[h]).map(o=>[o,r[h][o]]))}),n?qe(t):null}};var k=class{name="SmartRouter";#t=[];#e=[];constructor(e){this.#t=e.routers}add(e,t,n){if(!this.#e)throw new Error(j);this.#e.push([e,t,n])}match(e,t){if(!this.#e)throw new Error("Fatal error");let n=this.#t,r=this.#e,a=n.length,o=0,d;for(;o<a;o++){let c=n[o];try{for(let i=0,l=r.length;i<l;i++)c.add(...r[i]);d=c.match(e,t)}catch(i){if(i instanceof P)continue;throw i}this.match=c.match.bind(c),this.#t=[c],this.#e=void 0;break}if(o===a)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,d}get activeRouter(){if(this.#e||this.#t.length!==1)throw new Error("No active router has been determined yet.");return this.#t[0]}};var B=Object.create(null),$=class s{#t;#e;#r;#a=0;#s=B;constructor(e,t,n){if(this.#e=n||Object.create(null),this.#t=[],e&&t){let r=Object.create(null);r[e]={handler:t,possibleKeys:[],score:0},this.#t=[r]}this.#r=[]}insert(e,t,n){this.#a=++this.#a;let r=this,a=ie(t),o=[];for(let i=0,l=a.length;i<l;i++){let u=a[i];if(Object.keys(r.#e).includes(u)){r=r.#e[u];let g=Q(u);g&&o.push(g[1]);continue}r.#e[u]=new s;let p=Q(u);p&&(r.#r.push(p),o.push(p[1])),r=r.#e[u]}let d=Object.create(null),c={handler:n,possibleKeys:o.filter((i,l,u)=>u.indexOf(i)===l),score:this.#a};return d[e]=c,r.#t.push(d),r}#n(e,t,n,r){let a=[];for(let o=0,d=e.#t.length;o<d;o++){let c=e.#t[o],i=c[t]||c[h],l={};if(i!==void 0&&(i.params=Object.create(null),a.push(i),n!==B||r&&r!==B))for(let u=0,p=i.possibleKeys.length;u<p;u++){let g=i.possibleKeys[u],f=l[i.score];i.params[g]=r?.[g]&&!f?r[g]:n[g]??r?.[g],l[i.score]=!0}}return a}search(e,t){let n=[];this.#s=B;let a=[this],o=z(t);for(let d=0,c=o.length;d<c;d++){let i=o[d],l=d===c-1,u=[];for(let p=0,g=a.length;p<g;p++){let f=a[p],m=f.#e[i];m&&(m.#s=f.#s,l?(m.#e["*"]&&n.push(...this.#n(m.#e["*"],e,f.#s)),n.push(...this.#n(m,e,f.#s))):u.push(m));for(let y=0,x=f.#r.length;y<x;y++){let H=f.#r[y],R=f.#s===B?{}:{...f.#s};if(H==="*"){let W=f.#e["*"];W&&(n.push(...this.#n(W,e,f.#s)),u.push(W));continue}if(i==="")continue;let[J,se,F]=H,E=f.#e[J],ae=o.slice(d).join("/");if(F instanceof RegExp&&F.test(ae)){R[se]=ae,n.push(...this.#n(E,e,f.#s,R));continue}(F===!0||F.test(i))&&(R[se]=i,l?(n.push(...this.#n(E,e,R,f.#s)),E.#e["*"]&&n.push(...this.#n(E.#e["*"],e,R,f.#s))):(E.#s=R,u.push(E)))}}a=u}return n.length>1&&n.sort((d,c)=>d.score-c.score),[n.map(({handler:d,params:c})=>[d,c])]}};var I=class{name="TrieRouter";#t;constructor(){this.#t=new $}add(e,t,n){let r=N(t);if(r){for(let a=0,o=r.length;a<o;a++)this.#t.insert(e,r[a],n);return}this.#t.insert(e,t,n)}match(e,t){return this.#t.search(e,t)}};var A=class extends q{constructor(e={}){super(e),this.router=e.router??new k({routers:[new M,new I]})}};var Se={"Cache-Control":"no-cache",Connection:"keep-alive","Content-Type":"text/event-stream"};var K=class{constructor(){}send(e,t,n){let{eventId:r,retryDuration:a}=n||{},o=[`event: ${e}
`],d=r?[`id: ${r}
`]:[],c=[`retry: ${a??1e3}
`];return o.concat(d,c,t.map(i=>`data: ${i}
`),[`

`])}eachNewlineIsADataLine(e,t){return t.split(`
`).map(n=>`${e} ${n}`)}eachOptionIsADataLine(e){return Object.keys(e).flatMap(t=>this.eachNewlineIsADataLine(t,e[t].toString()))}mergeFragments(e,t){let{eventId:n,retryDuration:r,...a}=t||{},o=this.eachOptionIsADataLine(a).concat(this.eachNewlineIsADataLine("fragments",e));return this.send("datastar-merge-fragments",o,{eventId:n,retryDuration:r})}removeFragments(e,t){let{eventId:n,retryDuration:r,...a}=t||{},o=this.eachOptionIsADataLine(a).concat(this.eachNewlineIsADataLine("selector",e));return this.send("datastar-remove-fragments",o,{eventId:n,retryDuration:r})}mergeSignals(e,t){let{eventId:n,retryDuration:r,...a}=t||{},o=this.eachOptionIsADataLine(a).concat(this.eachNewlineIsADataLine("signals",JSON.stringify(e)));return this.send("datastar-merge-signals",o,{eventId:n,retryDuration:r})}removeSignals(e,t){let n=t||{},r=e.flatMap(a=>a.split(" ")).map(a=>`paths ${a}`);return this.send("datastar-remove-signals",r,n)}executeScript(e,t){let{eventId:n,retryDuration:r,attributes:a,...o}=t||{},c=this.eachOptionIsADataLine(a??{}).map(i=>`attributes ${i}`).concat(this.eachOptionIsADataLine(o),this.eachNewlineIsADataLine("script",e));return this.send("datastar-execute-script",c,{eventId:n,retryDuration:r})}};function re(s){return typeof s=="object"&&s!==null}var v=class s extends K{controller;constructor(e){super(),this.controller=e}static stream(e){let t=new ReadableStream({async start(n){let r=e(new s(n));r instanceof Promise&&await r,n.close()}});return new Response(t,{headers:Se})}send(e,t,n){let r=super.send(e,t,n);return r.forEach(a=>{this.controller?.enqueue(new TextEncoder().encode(a))}),r}static async readSignals(e){try{if(e.method==="GET"){let r=new URL(e.url).searchParams;if(r.has("datastar")){let a=JSON.parse(r.get("datastar"));if(re(a))return{success:!0,signals:a};throw new Error("Datastar param is not a record")}else throw new Error("No datastar object in request")}let t=await e.json();if(re(t))return{success:!0,signals:t};throw new Error("Parsed JSON body is not of type record")}catch(t){return re(t)&&"message"in t&&typeof t.message=="string"?{success:!1,error:t.message}:{success:!1,error:"unknown error when parsing request"}}}};var Pe=()=>{try{return self instanceof ServiceWorkerGlobalScope}catch{return!1}},be=Pe()?"Service Worker":"Deno Server";function De(){let s=new A;s.get("/",n=>n.html(`
        <html><head>
        <script type="module" src="https://cdn.jsdelivr.net/gh/starfederation/datastar@1.0.0-beta.1/bundles/datastar.js"><\/script>
        <style>
            .offline-notice { display: none; color: red; }
            .offline .offline-notice { display: block; }
            #largeContent { 
                height: 450px; 
                overflow: auto; 
                border: 1px solid #ccc; 
            }
            .stats { margin: 20px 0; padding: 10px; background: #f0f0f0; }
            .progress {
                position: sticky;
                top: 0;
                background: #fff;
                padding: 10px;
                border-bottom: 1px solid #ccc;
            }
            .item {
                padding: 10px;
                margin: 5px 0;
                border: 1px solid #eee;
                animation: fadeIn 0.5s ease-in;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
        </style>
        </head><body>
        <div class="offline-notice">\u26A0\uFE0F You are offline - using service worker</div>
        
        <div class="stats">
            Check the Network tab in DevTools to compare transfer sizes and times.<br>
        </div>
        
        <div id="largeContent">
            <div class="progress">Content will stream here... (0 items received)</div>
        </div>
        
        <div class="compression-options">
            <h4>Streaming Data</h4>
                        
            <button data-on-click="@get('/large-data')">
                Streamed Fragments
            </button>

            <h4>Bulk Data</h4>
            <button data-on-click="@get('/large-data?bulk=true')">
                Bulk Fragment
            </button>
        </div>

        <hr>
        <h3>Original Demo</h3>
        <div id="toMerge" data-on-load="@get('/merge')">Not merged</div>
                
        <script>
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => console.log('Service Worker registered:', registration.scope))
                    .catch(error => console.log('Service Worker registration failed:', error));
            }
            
            // Update UI based on online/offline status
            function updateOnlineStatus() {
                document.body.classList.toggle('offline', !navigator.onLine);
            }
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();

            // Update progress counter
            const observer = new MutationObserver((mutations) => {
                const items = document.querySelectorAll('.item').length;
                const progress = document.querySelector('.progress');
                if (progress) {
                    progress.textContent = 'Streaming content..... (' + items + ' items received)';
                }
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        <\/script>
        </body></html>
    `));let e=n=>`
  <div class="item">
      <h2>Sample Content #${n+1}</h2>
      <p>This is a longer piece of content that will be repeated many times to demonstrate compression effectiveness.</p>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
  </div>
`,t=Array.from({length:100},(n,r)=>e(r)).join(`
`);return s.get("/large-data",async n=>{let r=n.req.query("bulk")==="true";return v.stream(async a=>{if(a.mergeFragments(`<div id="largeContent">
              <h1> ${r?"Bulk":"Streaming"} Content (from ${be})</h1>
              <div id="items"></div>
          </div>`),r)a.mergeFragments(t,{selector:"#items",mergeMode:"append"});else for(let o=0;o<100;o++)a.mergeFragments(e(o),{selector:"#items",mergeMode:"append"}),await Te(15)})}),s.get("/merge",async n=>v.stream(async r=>{r.mergeFragments(`<div id="toMerge">Merged (from ${be})</div>`)})),s.get("/await",async n=>v.stream(async r=>{r.mergeFragments('<div id="toMerge">Merged</div>'),await Te(1e4),r.mergeFragments('<div id="toMerge">After 10 seconds</div>')})),s.all("*",async n=>Pe()?await fetch(n.req.raw):n.text(`Path not found: ${n.req.url}`,404)),s}function Te(s){return new Promise(e=>{setTimeout(e,s)})}var Ue=De();self.addEventListener("fetch",s=>{s.request.url.includes("/service-worker.js")||s.respondWith((async()=>{try{return await fetch(s.request)}catch{return console.log("Network request failed, using service worker response."),Ue.fetch(s.request,{headers:s.request.headers})}})())});self.addEventListener("install",s=>{self.skipWaiting()});self.addEventListener("activate",s=>{s.waitUntil(self.clients.claim())});
