# https://taskfile.dev

version: "3"

interval: 1000ms

vars:
  VERSION:
    sh: cat VERSION

tasks:
  version:
    cmds:
      - echo {{.VERSION}}

  library:
    dir: library
    requires:
      vars: [VERSION]
    sources:
      - "**/*.ts"
      - "**/*.js"
      - "**/*.json"
    generates:
      - "dist/**/*"
    cmds:
      - pnpm i
      - pnpm build

  test-sdk:
    desc: Run SDK tests
    dir: sdk/tests
    env:
      TEST_SERVER_URL: '{{.SERVER | default "http://localhost:7331"}}'
    cmds:
      - go mod tidy
      - go test -v ./...

  install-sdk-tests:
    desc: Install the datastar-sdk-tests command
    dir: sdk/tests
    cmds:
      - go install ./cmd/datastar-sdk-tests

  build-sdk-tests-docker:
    desc: Build Docker image for datastar-sdk-tests
    dir: sdk/tests
    sources:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
      - "Dockerfile"
    generates:
      - ".docker-build-timestamp"
    cmds:
      - docker build -t datastar-sdk-tests:latest .
      - touch .docker-build-timestamp

  run-sdk-tests-docker:
    desc: Run datastar-sdk-tests in Docker container
    deps: [build-sdk-tests-docker]
    cmds:
      - docker run --rm --network host datastar-sdk-tests:latest {{.CLI_ARGS}}
