// Datastar v1.0.0-beta.1
var X=/ðŸ–•JS_DSðŸš€/.source,D=X.slice(0,5),W=X.slice(4),Z="datastar";var Q="1.0.0-beta.1";var ve={Morph:"morph",Inner:"inner",Outer:"outer",Prepend:"prepend",Append:"append",Before:"before",After:"after",UpsertAttributes:"upsertAttributes"},we=ve.Morph;var Se="computed",ee={type:1,name:Se,keyReq:1,valReq:1,onLoad:({key:t,signals:e,genRX:n})=>{let s=n();e.setComputed(t,s)}};var te=t=>t.replace(/(?:^\w|[A-Z]|\b\w)/g,(e,n)=>n===0?e.toLowerCase():e.toUpperCase()).replace(/\s+/g,""),ne=t=>new Function(`return Object.assign({}, ${t})`)();var se={type:1,name:"signals",valReq:1,removeOnLoad:!0,onLoad:t=>{let{key:e,genRX:n,signals:s,mods:i}=t,a=i.has("ifmissing");if(e!==""&&!a)s.setValue(e,n()());else{let r=ne(t.value);t.value=JSON.stringify(r);let p=n()();s.merge(p,a)}}};var ie={type:1,name:"star",keyReq:2,valReq:2,onLoad:()=>{alert("YOU ARE PROBABLY OVERCOMPLICATING IT")}};var R=class{#e=0;#t;constructor(e=Z){this.#t=e}with(e){if(typeof e=="string")for(let n of e.split(""))this.with(n.charCodeAt(0));else this.#e=(this.#e<<5)-this.#e+e;return this}reset(){return this.#e=0,this}get value(){return this.#t+Math.abs(this.#e).toString(36)}};function re(t){if(t.id)return t.id;let e=new R,n=t;for(;n.parentNode;){if(n.id){e.with(n.id);break}if(n===n.ownerDocument.documentElement)e.with(n.tagName);else{for(let s=1,i=t;i.previousElementSibling;i=i.previousElementSibling,s++)e.with(s);n=n.parentNode}n=n.parentNode}return e.value}var xe="http://localhost:8080/errors";var c=(t,e)=>{let n=new Error;n.name=t;let s=`${xe}/${t}?${new URLSearchParams(e)}`;return n.message=`for more info see ${s}`,n};var be=Symbol.for("preact-signals"),_=1,T=2,O=4,N=8,k=16,w=32;function H(){P++}function z(){if(P>1){P--;return}let t,e=!1;for(;A!==void 0;){let n=A;for(A=void 0,U++;n!==void 0;){let s=n._nextBatchedEffect;if(n._nextBatchedEffect=void 0,n._flags&=~T,!(n._flags&N)&&ae(n))try{n._callback()}catch(i){e||(t=i,e=!0)}n=s}}if(U=0,P--,e)throw c("BatchError, error",{error:t})}var o;var A,P=0,U=0,V=0;function oe(t){if(o===void 0)return;let e=t._node;if(e===void 0||e._target!==o)return e={_version:0,_source:t,_prevSource:o._sources,_nextSource:void 0,_target:o,_prevTarget:void 0,_nextTarget:void 0,_rollbackNode:e},o._sources!==void 0&&(o._sources._nextSource=e),o._sources=e,t._node=e,o._flags&w&&t._subscribe(e),e;if(e._version===-1)return e._version=0,e._nextSource!==void 0&&(e._nextSource._prevSource=e._prevSource,e._prevSource!==void 0&&(e._prevSource._nextSource=e._nextSource),e._prevSource=o._sources,e._nextSource=void 0,o._sources._nextSource=e,o._sources=e),e}function f(t){this._value=t,this._version=0,this._node=void 0,this._targets=void 0}f.prototype.brand=be;f.prototype._refresh=()=>!0;f.prototype._subscribe=function(t){this._targets!==t&&t._prevTarget===void 0&&(t._nextTarget=this._targets,this._targets!==void 0&&(this._targets._prevTarget=t),this._targets=t)};f.prototype._unsubscribe=function(t){if(this._targets!==void 0){let e=t._prevTarget,n=t._nextTarget;e!==void 0&&(e._nextTarget=n,t._prevTarget=void 0),n!==void 0&&(n._prevTarget=e,t._nextTarget=void 0),t===this._targets&&(this._targets=n)}};f.prototype.subscribe=function(t){return I(()=>{let e=this.value,n=o;o=void 0;try{t(e)}finally{o=n}})};f.prototype.valueOf=function(){return this.value};f.prototype.toString=function(){return`${this.value}`};f.prototype.toJSON=function(){return this.value};f.prototype.peek=function(){let t=o;o=void 0;try{return this.value}finally{o=t}};Object.defineProperty(f.prototype,"value",{get(){let t=oe(this);return t!==void 0&&(t._version=this._version),this._value},set(t){if(t!==this._value){if(U>100)throw c("SignalCycleDetected");this._value=t,this._version++,V++,H();try{for(let e=this._targets;e!==void 0;e=e._nextTarget)e._target._notify()}finally{z()}}}});function ae(t){for(let e=t._sources;e!==void 0;e=e._nextSource)if(e._source._version!==e._version||!e._source._refresh()||e._source._version!==e._version)return!0;return!1}function le(t){for(let e=t._sources;e!==void 0;e=e._nextSource){let n=e._source._node;if(n!==void 0&&(e._rollbackNode=n),e._source._node=e,e._version=-1,e._nextSource===void 0){t._sources=e;break}}}function ue(t){let e=t._sources,n;for(;e!==void 0;){let s=e._prevSource;e._version===-1?(e._source._unsubscribe(e),s!==void 0&&(s._nextSource=e._nextSource),e._nextSource!==void 0&&(e._nextSource._prevSource=s)):n=e,e._source._node=e._rollbackNode,e._rollbackNode!==void 0&&(e._rollbackNode=void 0),e=s}t._sources=n}function x(t){f.call(this,void 0),this._fn=t,this._sources=void 0,this._globalVersion=V-1,this._flags=O}x.prototype=new f;x.prototype._refresh=function(){if(this._flags&=~T,this._flags&_)return!1;if((this._flags&(O|w))===w||(this._flags&=~O,this._globalVersion===V))return!0;if(this._globalVersion=V,this._flags|=_,this._version>0&&!ae(this))return this._flags&=~_,!0;let t=o;try{le(this),o=this;let e=this._fn();(this._flags&k||this._value!==e||this._version===0)&&(this._value=e,this._flags&=~k,this._version++)}catch(e){this._value=e,this._flags|=k,this._version++}return o=t,ue(this),this._flags&=~_,!0};x.prototype._subscribe=function(t){if(this._targets===void 0){this._flags|=O|w;for(let e=this._sources;e!==void 0;e=e._nextSource)e._source._subscribe(e)}f.prototype._subscribe.call(this,t)};x.prototype._unsubscribe=function(t){if(this._targets!==void 0&&(f.prototype._unsubscribe.call(this,t),this._targets===void 0)){this._flags&=~w;for(let e=this._sources;e!==void 0;e=e._nextSource)e._source._unsubscribe(e)}};x.prototype._notify=function(){if(!(this._flags&T)){this._flags|=O|T;for(let t=this._targets;t!==void 0;t=t._nextTarget)t._target._notify()}};Object.defineProperty(x.prototype,"value",{get(){if(this._flags&_)throw c("SignalCycleDetected");let t=oe(this);if(this._refresh(),t!==void 0&&(t._version=this._version),this._flags&k)throw c("GetComputedError",{value:this._value});return this._value}});function ce(t){return new x(t)}function fe(t){let e=t._cleanup;if(t._cleanup=void 0,typeof e=="function"){H();let n=o;o=void 0;try{e()}catch(s){throw t._flags&=~_,t._flags|=N,Y(t),c("CleanupEffectError",{error:s})}finally{o=n,z()}}}function Y(t){for(let e=t._sources;e!==void 0;e=e._nextSource)e._source._unsubscribe(e);t._fn=void 0,t._sources=void 0,fe(t)}function Ee(t){if(o!==this)throw c("EndEffectError");ue(this),o=t,this._flags&=~_,this._flags&N&&Y(this),z()}function M(t){this._fn=t,this._cleanup=void 0,this._sources=void 0,this._nextBatchedEffect=void 0,this._flags=w}M.prototype._callback=function(){let t=this._start();try{if(this._flags&N||this._fn===void 0)return;let e=this._fn();typeof e=="function"&&(this._cleanup=e)}finally{t()}};M.prototype._start=function(){if(this._flags&_)throw c("SignalCycleDetected");this._flags|=_,this._flags&=~N,fe(this),le(this),H();let t=o;return o=this,Ee.bind(this,t)};M.prototype._notify=function(){this._flags&T||(this._flags|=T,this._nextBatchedEffect=A,A=this)};M.prototype._dispose=function(){this._flags|=N,this._flags&_||Y(this)};function I(t){let e=new M(t);try{e._callback()}catch(n){throw e._dispose(),n}return e._dispose.bind(e)}function de(t,e=!1){let n={};for(let s in t)if(Object.hasOwn(t,s)){if(e&&s.startsWith("_"))continue;let i=t[s];i instanceof f?n[s]=i.value:n[s]=de(i)}return n}function pe(t,e,n=!1){for(let s in e)if(Object.hasOwn(e,s)){if(s.match(/\_\_+/))throw c("InvalidSignalKey",{key:s});let i=e[s];if(i instanceof Object&&!Array.isArray(i))t[s]||(t[s]={}),pe(t[s],i,n);else{if(Object.hasOwn(t,s)){if(n)continue;let r=t[s];if(r instanceof f){r.value=i;continue}}t[s]=new f(i)}}}function ge(t,e){for(let n in t)if(Object.hasOwn(t,n)){let s=t[n];s instanceof f?e(n,s):ge(s,(i,a)=>{e(`${n}.${i}`,a)})}}function Te(t,...e){let n={};for(let s of e){let i=s.split("."),a=t,r=n;for(let p=0;p<i.length-1;p++){let u=i[p];if(!a[u])return{};r[u]||(r[u]={}),a=a[u],r=r[u]}let l=i[i.length-1];r[l]=a[l]}return n}var F=class{#e={};exists(e){return!!this.signal(e)}signal(e){let n=e.split("."),s=this.#e;for(let r=0;r<n.length-1;r++){let l=n[r];if(!s[l])return null;s=s[l]}let i=n[n.length-1],a=s[i];if(!a)throw c("SignalNotFound",{path:e});return a}setSignal(e,n){let s=e.split("."),i=this.#e;for(let r=0;r<s.length-1;r++){let l=s[r];i[l]||(i[l]={}),i=i[l]}let a=s[s.length-1];i[a]=n}setComputed(e,n){let s=ce(()=>n());this.setSignal(e,s)}value(e){return this.signal(e)?.value}setValue(e,n){let s=this.upsertIfMissing(e,n);s.value=n}upsertIfMissing(e,n){let s=e.split("."),i=this.#e;for(let p=0;p<s.length-1;p++){let u=s[p];i[u]||(i[u]={}),i=i[u]}let a=s[s.length-1],r=i[a];if(r instanceof f)return r;let l=new f(n);return i[a]=l,l}remove(...e){for(let n of e){let s=n.split("."),i=this.#e;for(let r=0;r<s.length-1;r++){let l=s[r];if(!i[l])return;i=i[l]}let a=s[s.length-1];delete i[a]}}merge(e,n=!1){pe(this.#e,e,n)}subset(...e){return Te(this.values(),...e)}walk(e){ge(this.#e,e)}paths(){let e=new Array;return this.walk(n=>e.push(n)),e}values(e=!1){return de(this.#e,e)}JSON(e=!0,n=!1){let s=this.values(n);return e?JSON.stringify(s,null,2):JSON.stringify(s)}toString(){return this.JSON()}};var $=class{#e=new F;#t=[];#r=[];#s={};#a=[];#n=new Map;get signals(){return this.#e}get version(){return Q}load(...e){for(let n of e){let s;switch(n.type){case 0:{this.#r.push(n);break}case 2:{let i=n;this.#a.push(i),s=i.onGlobalInit;break}case 3:{this.#s[n.name]=n;break}case 1:{let i=n;this.#t.push(i),s=i.onGlobalInit;break}default:throw c("InvalidPluginType",{name:n.name,type:n.type})}if(s){let i=this;s({get signals(){return i.#e},effect:a=>I(a),actions:this.#s,apply:this.apply.bind(this),cleanup:this.#i.bind(this)})}}this.apply(document.body)}apply(e){let n=new Set;this.#t.forEach((s,i)=>{let a=s.name;this.#o(e,r=>{if(!("starIgnore"in r.dataset)){i||this.#i(r);for(let l in r.dataset){if(!l.startsWith(s.name))continue;let p=l.slice(s.name.length),[u,...L]=p.split(/\_\_+/),b=u.length>0;b&&(u.startsWith("-")?u=u.slice(1):u=u[0].toLowerCase()+u.slice(1));let E=`${r.dataset[l]}`||"",y=E.length>0,v=s.keyReq||0;if(b){if(v===2)throw c(`${s.name}KeyNotAllowed`,{key:u})}else if(v===1)throw c(`${s.name}KeyRequired`);let d=s.valReq||0;if(y){if(d===2)throw c(`${s.name}ValueNotAllowed`,{rawValue:E})}else if(d===1)throw c(`${s.name}ValueRequired`);if(v===3||d===3){if(b&&y)throw c(`${s.name}KeyAndValueProvided`);if(!b&&!y)throw c(`${s.name}KeyOrValueRequired`)}r.id.length||(r.id=re(r));let h=new Map;for(let m of L){let[B,...G]=m.split(".");h.set(te(B),new Set(G.map(q=>q.toLowerCase())))}let g=this,S={get signals(){return g.#e},effect:m=>I(m),apply:g.apply.bind(g),cleanup:g.#i.bind(g),actions:g.#s,genRX:()=>this.#l(S,...s.argNames||[]),pluginName:a,el:r,rawKey:l,rawValue:E,key:u,value:E,mods:h};n.clear();let j=[...s.macros?.pre||[],...this.#r,...s.macros?.post||[]];for(let m of j)n.has(m)||(n.add(m),S.value=m.fn(S,S.value));let C=s.onLoad(S);C&&(this.#n.has(r)||this.#n.set(r,{id:r.id,set:new Set}),this.#n.get(r)?.set.add(C)),s?.removeOnLoad&&delete r.dataset[l]}}})})}#l(e,...n){let s=e.value.split(/;|\n/).map(d=>d.trim()).filter(d=>d!==""),i=s.length-1;s[i].startsWith("return")||(s[i]=`return (${s[i]});`);let r=s.join(`;
`).trim(),l=new Map,p=new RegExp(`(?:${D})(.*?)(?:${W})`,"gm");for(let d of r.matchAll(p)){let h=d[1],g=new R("dsEscaped").with(h).value;l.set(g,h),r=r.replace(D+h+W,g)}let u=/@(\w*)\(/gm,L=r.matchAll(u),b=new Set;for(let d of L)b.add(d[1]);let E=new RegExp(`@(${Object.keys(this.#s).join("|")})\\(`,"gm");r=r.replaceAll(E,"ctx.actions.$1.fn(ctx,");let y=e.signals.paths();if(y.length){let d=new RegExp(`\\$(${y.join("|")})(\\W|$)`,"gm");r=r.replaceAll(d,"ctx.signals.signal('$1').value$2")}for(let[d,h]of l)r=r.replace(d,h);let v=`return (()=> {
${r}
})()`;try{let d=new Function("ctx",...n,v);return(...h)=>{try{return d(e,...h)}catch(g){let{pluginName:S,el:j,rawKey:C,rawValue:m,key:B,value:G}=e,q=j.id,me=y.map(ye=>`$${ye}`).join(", ");throw c("exec",{pluginName:S,elementId:q,error:g,validSignalNames:me,rawKey:C,rawValue:m,fnContent:v,mods:JSON.parse(JSON.stringify([...e.mods])),key:B,value:G})}}}catch(d){throw c("GeneratingExpressionFailed",{fnContent:v,error:d})}}#o(e,n){if(!e||!(e instanceof HTMLElement||e instanceof SVGElement))return null;n(e);let s=e.firstElementChild;for(;s;)this.#o(s,n),s=s.nextElementSibling}#i(e){let n=this.#n.get(e);if(n){for(let s of n.set)s();this.#n.delete(e)}}};var he=new $;he.load(ie,se,ee);var _e=he;var rt=_e;export{rt as Datastar};
//# sourceMappingURL=datastar-core.js.map
